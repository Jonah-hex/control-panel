# تحسينات نقل الملكية والوحدة — خطة عمل مترابطة

## 1. عداد الكهرباء ونقل الملكية

- **عند نقل الملكية:** إضافة خيار «تم نقل عداد الكهرباء مع الوحدة» (حقل: `electricity_meter_transferred_with_sale`).
- **إذا تم النقل:** رقم العداد يصبح **غير قابل للتعديل** في جدول عدادات الكهرباء (كارد عدادات الكهرباء في تفاصيل المبنى) لأنه مرتبط بنقل الملكية.
- **إذا تم إفراغ الوحدة بدون نقل العداد:** إرسال **تنبيه دوري كل 5 أيام** للمالك وأصحاب الصلاحيات: «تنبيه بنقل العداد».

## 2. الإشعارات

- **عند نقل الملكية:** إرسال إشعار للمالك وأصحاب الصلاحيات: «تم نقل ملكية الوحدة X إلى [المشتري]».
- **تنبيه دوري (كل 5 أيام):** للوحدات المباعة التي لم يُنقل عدادها («يُنصح بنقل عداد الكهرباء»).
- آلية مقترحة: جدول `notifications` أو `alerts` + إدخال عند نقل الملكية؛ التنبيه الدوري عبر مهمة مجدولة (cron) أو فحص عند تسجيل الدخول.

## 3. معاينة استلام الوحدة

- قسم/شاشة «معاينة استلام الوحدة» — **جاهز للربط لاحقاً** (مكان احتياطي في الواجهة أو مسار مخصص).

## 4. تسجيل اتحاد الملاك

- حقل على مستوى الوحدة: **«مسجل في اتحاد الملاك»** (`owner_association_registered`).
- إذا تم التسجيل يُحسب في **عدد الوحدات المسجلة** في نظام اتحاد الملاك (في كارد اتحاد الملاك أو حقل `registeredUnitsCount` يمكن أن يُستمد من عدد الوحدات التي لديها `owner_association_registered = true` أو يبقى يدوياً مع توثيق المنطق).

## 5. غرفة سائق

- **على مستوى الوحدة:** الحقل `driver_room` موجود في الجدول وصفحة تعديل الوحدة.
- **على مستوى المبنى:** الحقل `driver_rooms` (عدد) موجود في تفاصيل المبنى.
- التأكد من ظهورهما في الواجهات المناسبة واستخدامهما بشكل مترابط عند الحاجة.

---

## تنفيذ مرحلي

| المرحلة | المطلوب | الحالة |
|--------|---------|--------|
| أ | أعمدة: `electricity_meter_transferred_with_sale`, `owner_association_registered` في `units` | ✅ مخطط (ملف SQL جاهز) |
| ب | في مودال نقل الملكية: خيار «تم نقل عداد الكهرباء مع الوحدة» + حفظ | ✅ منفّذ |
| ج | كارد عدادات الكهرباء: منع تعديل العداد للوحدة المباعة إذا «تم نقل العداد مع الوحدة» | ✅ منفّذ |
| د | إشعار عند نقل الملكية: مُسجّل في `activity_logs` (ownership_transferred). إدراج في جدول `notifications` للمالك يمكن إضافته لاحقاً حسب RLS. | جزئي (activity_log) |
| هـ | مكان احتياطي «معاينة استلام الوحدة» في بطاقة المالك | ✅ منفّذ (قريباً) |
| و | ربط عدد الوحدات المسجلة في اتحاد الملاك بحقل الوحدة `owner_association_registered` (أو توثيق المنطق) | لاحقاً |
| ز | تنبيه دوري كل 5 أيام للمالك (نقل العداد) — مهمة مجدولة أو فحص عند الدخول | لاحقاً |
| ح | غرفة سائق: موجودة على الوحدة (`driver_room`) وفي المبنى (`driver_rooms`) — التأكد من ظهورها حيث يلزم | مراجعة واجهات |
