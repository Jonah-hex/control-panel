# آلية نقل الملكية وترابط الجداول

## السيناريوهان

### 1) بيع عبر الحجوزات (إدارة الحجوزات)
- يُنشأ حجز → `reservations` (حالة active) + `units.status = reserved`
- عند إتمام البيع من واجهة الحجوزات:
  - يُدرج سجل في `sales`
  - `units.status = sold`
  - `reservations.status = completed` وربط `sale_id`

### 2) نقل ملكية مباشر (بدون حجز) — من صفحة الصكوك
- المستخدم ينقل ملكية الوحدة للمشتري مباشرة بدون مرور بحجز.
- **ما يحدث بعد التكامل:**
  - تحديث `units` (status = sold + بيانات المالك، الشيك، الهوية، إلخ).
  - إدراج سجل في `sales` (وحدة، مبنى، مشتري، تاريخ، سعر من مبلغ الشيك أو 0، ملاحظة «نقل ملكية مباشر — بدون حجز»).
  - إدراج سجل في `activity_logs` (action_type: `ownership_transferred`).
- **ما لا يُمس:** `reservations`، `buildings.reserved_units`.

---

## ما المُفترض تحديثه عند نقل ملكية مباشر (بدون حجز)

| الجدول/الحقل | الإجراء المطلوب | السبب |
|---------------|------------------|--------|
| **units** | ✅ يتم حالياً | تحديث `status = sold` + بيانات المشتري ونقل الملكية (owner_name, owner_phone, transfer_*, …). |
| **sales** | ⚠️ يُفضّل إضافة سجل | حتى يظهر البيع في «سجل المبيعات» والتقارير المعتمدة على `sales`. |
| **reservations** | ❌ لا تغيير | لا يوجد حجز؛ لا داعي لإنشاء أو تعديل حجز. |
| **buildings.reserved_units** | ❌ لا تغيير (عادة) | الوحدة لم تكن محجوزة؛ العدد يُحسب من الوحدات ذات `status = reserved`. إذا كان هناك منطق يحدّث `reserved_units` عند تحويل حجز إلى بيع فيمكن تطبيقه في مسار الحجوزات فقط. |
| **activity_logs** | ⚠️ يُفضّل إضافة سجل | لتوثيق «نقل ملكية» في سجل النشاط واللوحة. |

---

## الفلاتر وحالة الوحدة

- **قوائم الوحدات وفلتر الحالة:** تعتمد على `units.status` (available / reserved / sold) → الوحدة المباعة مباشرة تظهر **مباعة** بشكل صحيح.
- **سجل المبيعات:** يعتمد على جدول `sales` فقط → المبيعات الناتجة عن نقل ملكية مباشر **لا تظهر** ما لم نُدرج لها سجلاً في `sales`.
- **الإحصائيات/التقارير:** إن كانت تعتمد على `units` (عد الوحدات المباعة من `units.status = sold`) تكون صحيحة؛ إن كانت تعتمد على `sales` فستفقد مبيعات النقل المباشر ما لم نُدرجها في `sales`.

---

## التوصية (الآلية المقترحة عند نقل ملكية مباشر)

1. **الإبقاء على ما هو قائم:** تحديث `units` (status + كل حقول نقل الملكية).
2. **إضافة سجل في `sales`:**
   - إنشاء صف في `sales` عند كل نقل ملكية مباشر (بدون حجز).
   - ربطه بـ `unit_id` و `building_id`.
   - تعبئة: اسم المشتري، الجوال، تاريخ البيع (اليوم)، سعر البيع (مبلغ الشيك إن وُجد أو 0)، ملاحظة مثل «نقل ملكية مباشر — بدون حجز».
   - عدم ربطه بـ `reservations` (بدون `reservation_id` أو ترك الحقل null إن وُجد).
3. **إضافة سجل في `activity_logs`:**
   - نوع النشاط مثلاً: `ownership_transferred` أو `sale_direct`.
   - وصف مثل: «نقل ملكية الوحدة X إلى [اسم المشتري]».
   - ربطه بالمبنى/الوحدة والمستخدم إن أمكن.
4. **عدم المساس بـ `reservations` و`buildings.reserved_units`** في هذا المسار.

بعد تطبيق (2) و (3) يصبح النظام متسقاً: حالة الوحدة «مباعة»، ظهور البيع في سجل المبيعات، وتوثيق النقل في النشاط والفلترة حسب الحالة.
