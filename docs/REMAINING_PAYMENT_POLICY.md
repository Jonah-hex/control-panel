# سياسة المبالغ المتبقية من المبيعات

## الهدف
توضيح منطق وآلية تعامل النظام عندما يُحصّل المبلغ المتبقي من العميل بعد بيع جزئي (دفع أولي + متبقٍ).

---

## 1. مبلغ البيع وحالة الدفع

| الحقل | الوصف |
|--------|--------|
| `sale_price` | مبلغ البيع الكامل (ثابت — لا يتغير عند التحصيل). |
| `down_payment` | المبلغ المُحصّل في البداية (الدفعة الأولى). |
| `remaining_payment` | المبلغ المتبقي على العميل. عند التحصيل الكامل يُصبح `0` أو `null`. |
| `payment_status` | `pending` \| `partial` \| `completed`. |

- **عند إنشاء البيع (نقل الملكية):**
  - دفع كامل → `payment_status = 'completed'`, `remaining_payment = null`.
  - دفع جزئي → `payment_status = 'partial'`, `remaining_payment = المتبقي`, `remaining_payment_due_date = تاريخ الاستحقاق`.

- **عند تحصيل المتبقي (تأكيد اكتمال المبلغ):**
  - يتم تحديث السجل في `sales` فقط:
    - `payment_status = 'completed'`
    - `remaining_payment = 0` (أو `null`)
    - `remaining_payment_due_date = null`
  - **لا يُغيّر:** `sale_price`, `down_payment`, `commission_amount` — تبقى كما هي.

---

## 2. حالة الوحدة (Unit Status)

- الوحدة تنتقل إلى `status = 'sold'` **عند إتمام نقل الملكية** (سواء دفع كامل أو جزئي).
- **عند تحصيل المتبقي لاحقاً:** حالة الوحدة **لا تتغير** — تبقى `sold`.
- لا يوجد تحويل وحدة من "مباعة جزئياً" إلى "مباعة بالكامل" على مستوى الوحدة؛ التمييز فقط في جدول المبيعات عبر `payment_status`.

---

## 3. تغيير التنبيه من جزئي إلى مكتمل

- **قبل التحصيل:** البيع يظهر بحالة "جزئي" و"متبقي X ر.س" في سجل المبيعات والتقارير.
- **بعد تأكيد التحصيل:** البيع يظهر بحالة "مكتمل" ولا يظهر في تقرير المبالغ المتبقية.
- آلية التأكيد في الواجهة: زر **«تأكيد تحصيل المتبقي»** في تفاصيل البيع (صفحة المبيعات) يحدّث السجل كما في الفقرة 1 ويسجّل حدثاً في `activity_logs`.

---

## 4. تأكيد اكتمال المبلغ في النظام

1. **من واجهة المبيعات:** فتح تفاصيل البيع الذي حالته "جزئي" والضغط على **«تأكيد تحصيل المتبقي»**.
2. **التحديث في قاعدة البيانات:**
   - `sales.payment_status` ← `'completed'`
   - `sales.remaining_payment` ← `0` (أو `null`)
   - `sales.remaining_payment_due_date` ← `null`
3. **سجل النشاط:** إدراج سطر في `activity_logs` يوضح أن المتبقي تم تحصيله وتحديث حالة البيع إلى مكتمل.
4. **التقارير:** بعد التحديث يخرج البيع من "تقرير المبالغ المتبقية" ويُحسب ضمن المبيعات المكتملة الدفع.

---

## 5. ملخص التفاعل

| الحدث | مبلغ البيع | حالة الوحدة | payment_status | remaining_payment |
|--------|------------|-------------|----------------|-------------------|
| إنشاء بيع (دفع كامل) | ثابت | sold | completed | null |
| إنشاء بيع (دفع جزئي) | ثابت | sold | partial | المتبقي |
| تحصيل المتبقي | ثابت | sold (بدون تغيير) | completed | 0 أو null |

لا تُستحق العمولة من المتبقي؛ العمولة مرتبطة بمبلغ البيع (`sale_price`) ومسجّلة عند إنشاء البيع ولا تتغير عند تحصيل المتبقي.
