# نظام طلبات صيانة الوحدات السكنية — مقترح خبير

> **حالة المقترح:** محفوظ للتطبيق لاحقاً. يُطبّق مع نظام التسليم والمعاينة (انظر الأسفل).

## لماذا الطلبات تكون للوحدة وليس للعمارة فقط؟

في الواقع العملي:
- **البلاغ دائماً عن مكان محدد:** "تسريب في الحمام — الشقة ٣٠١" أو "تكييف لا يعمل — الوحدة ٥٠٢".
- **التكلفة والجدولة:** تُحسب وتُجدول حسب الوحدة (من يتحمل، أي مقاول، متى دخول للوحدة).
- **السجل التاريخي للوحدة:** عند البيع أو التأجير، سجل صيانة الوحدة مهم (تكرار أعطال، نوع المشاكل).
- **تخصيص الفني:** يُرسل لفني لـ **وحدة معيّنة** في عمارة معيّنة، وليس "عمارة بشكل عام".

لذلك: **كل طلب صيانة يجب أن يكون مرتبطاً بوحدة سكنية** (مع إمكانية "مناطق مشتركة" لاحقاً إن احتجت).

---

## آلية العمل (دورة حياة الطلب)

```
[البلاغ / إنشاء الطلب] → [معين لـ فني] → [قيد التنفيذ] → [مكتمل] أو [ملغى]
       pending              assigned         in_progress      completed / cancelled
```

1. **إنشاء الطلب (pending)**  
   - يختار المستخدم: **العمارة → الوحدة** ثم يملأ (العنوان، الوصف، نوع الصيانة، الأولوية).
   - يُسجّل تاريخ الطلب تلقائياً.

2. **التعيين (assigned)**  
   - يُختار **موظف من جدول الموظفين** (يفضل من له منصب "maintenance" أو "فني صيانة").
   - يُحدد **موعد مخطّط** (scheduled_date) لتنفيذ الصيانة.
   - يُسجّل تقدير تكلفة (estimated_cost) اختياري.

3. **قيد التنفيذ (in_progress)**  
   - عند بدء الفني العمل يُغيّر الحالة إلى "قيد التنفيذ".

4. **الإغلاق (completed أو cancelled)**  
   - عند الانتهاء: **تاريخ الإنجاز** (completion_date)، **التكلفة الفعلية** (actual_cost)، **ملاحظات الإنجاز** (completion_notes).
   - إن لم تُنفَّذ: إلغاء مع ملاحظة إن وجدت.

---

## الربط بـ "صيانة الوحدة"

| العنصر | الربط |
|--------|--------|
| **جدول البيانات** | `maintenance_requests.unit_id` → `units.id` (والعمارة من خلال `units.building_id` أو `maintenance_requests.building_id`). |
| **من صفحة العمارة** | قسم "طلبات الصيانة" يعرض كل الطلبات للعمارة، مع فلترة أو تجميع حسب الوحدة. |
| **من صفحة/قائمة الوحدات** | عند فتح تفاصيل وحدة (أو كارد الوحدة): عرض "سجل صيانة هذه الوحدة" (طلبات سابقة + حالة الطلبات الحالية). |
| **إنشاء طلب جديد** | دائماً: اختيار عمارة → اختيار وحدة → ثم باقي الحقول. |

بهذا الشكل: **صيانة الوحدة** = كل الطلبات التي `unit_id = هذه الوحدة`، وواجهة المستخدم تعكس هذا الربط في كل مكان (عمارة، وحدة، قائمة مركزية).

---

## المسارات في الواجهة (اقتراح)

| المسار | الغرض |
|--------|--------|
| **`/dashboard/maintenance`** | قائمة مركزية لجميع طلبات الصيانة (كل العمارات)، مع فلاتر: عمارة، وحدة، حالة، أولوية. |
| **`/dashboard/buildings/[id]`** | داخل صفحة العمارة: تاب أو قسم "طلبات الصيانة" يعرض طلبات هذه العمارة فقط، مع إمكانية "طلب صيانة جديد" يربط تلقائياً بالعمارة ثم يختار الوحدة. |
| **من صفحة الوحدات** | في تفاصيل الوحدة (أو من قائمة الوحدات عند الضغط على وحدة): قسم "سجل صيانة الوحدة" يظهر الطلبات التي `unit_id = هذه الوحدة`. |

لا حاجة لصفحة منفصلة لكل وحدة إن لم تكن موجودة؛ يكفي قسم داخل صفحة العمارة أو داخل عرض الوحدة (مثلاً في نفس الصفحة أو مودال).

---

## أنواع الصيانة والأولوية (مقترح للواجهة)

**نوع الصيانة (category):**  
كهرباء، سباكة، تكييف/تدفئة، نجارة، دهان، عام، أخرى.

**الأولوية (priority):**  
عاجل (تسريب، خطر)، عالي، عادي، منخفض.

هذه القيم يمكن أن تكون ثابتة في الواجهة أو في جدول مرجعي لاحقاً؛ الجدول الحالي يدعم `category` و `priority` كنص.

---

## التعيين على الفني (الموظف)

- جدول **staff** فيه منصب مثل `maintenance` أو "فني صيانة".
- حقل **assigned_to** في `maintenance_requests` يخزّن `staff.id` (أو مستخدم إذا كان الفني له حساب).
- في الواجهة: عند "تعيين" الطلب نعرض قائمة الموظفين المناسبين (مثلاً من لهم position = maintenance) أو كل موظفي العمارة، ويُختار واحد.

ملاحظة: الجدول الحالي يعرّف `assigned_to UUID` بدون مرجع صريح. يُفضّل إضافة foreign key إلى `staff.id` إن لم يكن موجوداً، حتى تكون "صيانة الوحدة" مرتبطة بفني معيّن من فريق العمارة.

---

## ملخص الفكرة كخبير صيانة وحدات

- **الوحدة هي محور الطلب:** كل طلب مرتبط بعمارة + وحدة، وسجل الصيانة يُعرض على مستوى الوحدة.
- **دورة حياة واضحة:** pending → assigned → in_progress → completed/cancelled، مع تواريخ وتكاليف وملاحظات إنجاز.
- **ربط واجهة واحد:** نفس الجدول يخدم القائمة المركزية، وصفحة العمارة، وسجل صيانة الوحدة.
- **تعيين فني من الموظفين:** استخدام staff وربط assigned_to بفني الصيانة.

إذا وافقت على هذه الفكرة، الخطوة التالية هي تطبيق الواجهة والمسارات أعلاه (صفحة/قسم طلبات الصيانة، ربط الوحدة، وسجل صيانة الوحدة) دون تغيير جذري في الجدول الحالي، مع إضافة مرجع `assigned_to` → `staff.id` إن لزم.

---

# نظام التسليم والمعاينة (يُضاف لاحقاً مع الصيانة)

## الفكرة

عند **بيع الوحدة لعميل جديد** يُجرى تسليم رسمي للوحدة يشمل:

1. **معاينة شاملة** لجميع أجزاء الوحدة السكنية (كهرباء، سباكة، أبواب، نوافذ، تكييف، دهان، أرضيات، إلخ).
2. **نموذج معاينة واستلام** يُوقّع عليه العميل (والطرف البائع إن لزم) يوثّق حالة الوحدة عند التسليم.
3. بعد التسليم: أي **خلل يظهر لاحقاً** يُعالَج عبر **طلب صيانة** — فيصبح واضحاً أن المشكلة حدثت بعد الاستلام.

## لماذا المعاينة والاستلام أهم؟

- **تقليل النزاعات:** وجود توقيع على حالة الوحدة عند التسليم يحدّ من ادعاءات "كانت معطلة من قبل".
- **وضوح المسؤولية:** ما قبل التوقيع = على البائع/الإدارة، ما بعد التوقيع = طلب صيانة عادي (ويمكن تحديد من يتحمل حسب العقد).
- **تقليص مشاكل الصيانة:** العميل يطمئن أن الوحدة مُعاينة بالكامل، وأي طلب صيانة لاحق يكون مُسجَّلاً وواضحاً.

## الربط بين النظامين

| المرحلة | الإجراء |
|---------|---------|
| **قبل البيع** | الوحدة قد يكون لها طلبات صيانة سابقة (إصلاحات قبل التسليم). |
| **عند البيع / التسليم** | تنفيذ **معاينة كاملة** + **نموذج استلام موقع** → يُربط بالوحدة وبعملية البيع (مثلاً sale_id أو تاريخ التسليم). |
| **بعد التسليم** | أي خلل جديد → **طلب صيانة** مرتبط بنفس الوحدة؛ السجل يوضح أن الطلب "بعد الاستلام". |

بهذا الشكل: **المعاينة والاستلام** تُطبَّق أولاً (أهم)، ثم **طلبات الصيانة** لأي خلل يظهر بعد ذلك — والفكرتان مكمّلتان ومهمّتان معاً.
